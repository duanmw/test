<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>贪食蛇</title>
	<style>
		.map{
			width: 800px;
			height: 400px;
			background-color: #ccc;
			position: relative;
		}
	</style>
</head>
<body>
	<div class="map"></div>
	<script>
		(function(win){
			function Random() {
			    }
			    Random.prototype.getRandom=function (min,max) {
			      return Math.floor(Math.random()*(max-min)+min);
			    };
			    //把局部对象暴露给window顶级对象,就成了全局的对象
			    win.Random=new Random();
		})(window);

		//产生食物小方块
		(function(){
			var elements=[];//用来保存每个食物小方块
			//var map=document.querySelector(".map");
			function Food(width,height,color){
				this.width=width||20;
				this.height=height||20;
				this.color=color || "green";
				this.x=0;
				this.y=0;
				this.element=document.createElement("div");
			}
			Food.prototype.init=function(map){
				//先删除食物
				remove();
				var div=this.element;
				div.style.position="absolute";
				div.style.width=this.width+"px";
				div.style.height=this.height+"px";
				div.style.backgroundColor=this.color;
				map.appendChild(div);
				this.x=Random.getRandom(0,map.offsetWidth/this.width)*this.width;
				this.y=Random.getRandom(0,map.offsetHeight/this.height)*this.height;
				this.element.style.left=this.x+"px";
				this.element.style.top=this.y+"px";
			}

			//私有函数，删除食物的
			function remove(){
				for (var i = 0; i < elements.length; i++) {
					//找到这个子元素的父级元素,然后删除这个子元素
					elements[i].parentNode.removeChild(elements[i]);
					//把elements数组中的这个子元素也要删除
        			elements.splice(i, 1);
				}
			}
			//把Food暴露给Window,外部可以使用
			window.Food = Food;
			// var food=new Food(20,20,"green");
			// food.init(map);
			// console.log(food.x+"--"+food.y);
		})();

		//自调用函数---产生小蛇
		(function(){
			var elements=[];//存放小蛇的每个身体部分

			function Snake(width,height,direction){
				//小蛇的每个部分的宽
				this.width = width || 20;
				this.height = height || 20;
				//小蛇的身体
				this.body = [
				  {x: 3, y: 2, color: "red"},//头
				  {x: 2, y: 2, color: "orange"},//身体
				  {x: 1, y: 2, color: "orange"}//身体
				];
				//方向
				this.direction = direction || "right";
			}
			Snake.prototype.init=function(map){
				//先删除之前的小蛇
				remove();
				for (var i = 0; i < this.body.length; i++) {
					var obj=this.body[i];
					var div=document.createElement("div");
					map.appendChild(div);

					div.style.position="absolute";
					div.style.width=this.width+"px";
					div.style.height=this.height+"px";

					div.style.left=obj.x*this.width+"px";
					div.style.top=obj.y*this.height+"px";
					div.style.backgroundColor=obj.color;
					elements.push(div);
				}
			}
			Snake.prototype.move=function(food,map){
				//改变小蛇的身体的坐标位置,不包括蛇头
				for (var i = this.body.length - 1; i > 0; i--) {
					this.body[i].x=this.body[i-1].x;
					this.body[i].y=this.body[i-1].y;
				}
				//判断方向---改变小蛇的头的坐标位置
				switch(this.direction){
					case "right":
						this.body[0].x+=1;
						break;
					case "left":
						this.body[0].x-=1;
						break;
					case "top":
						this.body[0].y-=1;
						break;
					case "bottom":
						this.body[0].y+=1;
						break;
				}
				//判断是否吃到食物
				var headX=this.body[0].x*this.width;
				var headY=this.body[0].y*this.height;
				//判断小蛇的头的坐标和食物的坐标是否相同
				if (headX==food.x&&headY==food.y) {
					var last=this.body[this.body.length-1];
					this.body.push({
						x:last.x,
						y:last.y,
						color:last.color
					});
					food.init(map);
				}
			}


			function remove(){
				var i=elements.length-1;
				for (; i >= 0; i--) {
					var ele=elements[i];
					ele.parentNode.removeChild(ele);
					elements.splice(i,1);
				}
			}
			window.Snake=Snake;
		})();

		//自调用函数---游戏对象
		(function(){
			var that=null;
			function Game(map){
				this.food=new Food();
				this.snake=new Snake();
				this.map=map;
				that=this;//保存当前的实例对象到that变量中
			}
			Game.prototype.init=function(){
				this.food.init(this.map);
				this.snake.init(this.map);
				 //调用自动移动小蛇的方法
				this.runSnake(this.food, this.map);
				//调用按键的方法
				this.bindKey();
			}
			Game.prototype.runSnake=function(food,map){
				var timeId=setInterval(function(){
					this.snake.move(food,map);
					this.snake.init(map);
					var maxX=map.offsetWidth/this.snake.width;
					var maxY=map.offsetHeight/this.snake.height;
					var headX=this.snake.body[0].x;
					var headY=this.snake.body[0].y;
					//判断是否撞墙
					if (headX<0 || headX>=maxX) {
						clearInterval(timeId);
						alert("游戏结束！");
					}
					if (headY < 0 || headY >= maxY) {
						clearInterval(timeId);
						alert("游戏结束！");
					}
				}.bind(that),150);
			}
			//设置用户按键,改变小蛇移动的方向
			Game.prototype.bindKey=function(){
				document.addEventListener("keydown",function(e){
					switch(e.keyCode){
						case 37:this.snake.direction="left";break;
						case 38:this.snake.direction="top";break;
						case 39:this.snake.direction="right";break;
						case 40:this.snake.direction="bottom";break;
					}
				}.bind(that),false);
			}


			//把Game暴露给window,外部就可以访问Game对象了
			window.Game = Game;
		})();

		// var food=new Food(20,20,"green");
		// food.init(document.querySelector(".map"));
		// var snake= new Snake();
		// snake.init(document.querySelector(".map"));
		//初始化游戏对象
		var gm = new Game(document.querySelector(".map"));

		//初始化游戏---开始游戏
		gm.init();
	</script>
</body>
</html>